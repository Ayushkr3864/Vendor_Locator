<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendorFindr Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body>

<div class="max-w-xl w-full p-6 bg-white rounded-xl shadow-2xl transition duration-500 hover:shadow-primary/50" id="container">
    <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">VendorFindr Hero Image</h1>
    <p class="text-center text-gray-600 mb-8">
        We're generating a professional hero image for your app's homepage using the Imagen 3 model.
    </p>

    <div id="image-display" class="w-full min-h-64 flex justify-center items-center bg-gray-100 rounded-lg overflow-hidden border border-gray-300">
        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-indigo-500 font-medium">Generating image, please wait...</p>
        </div>
    </div>

    <p id="error-message" class="text-red-500 text-center mt-4 hidden">An error occurred during image generation.</p>

    <div class="mt-6 p-4 bg-indigo-50 rounded-lg text-sm text-gray-700">
        <strong class="font-semibold text-indigo-700">Prompt Used:</strong>
        <span id="prompt-text">A modern, vibrant, and clean smartphone screen mockup displaying a map with service pins (e.g., plumber, cleaner) and a search bar for local vendors. Digital art, high detail, studio lighting.</span>
    </div>
</div>

<script>
    const imageDisplay = document.getElementById('image-display');
    const loadingIndicator = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const promptText = document.getElementById('prompt-text').textContent;

    /**
     * Exponential backoff retry mechanism for API calls.
     */
    async function fetchWithRetry(url, options, maxRetries = 5) {
        let lastError = null;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                lastError = error;
                // Wait using exponential backoff: 2^i * 1000 ms
                const delay = Math.pow(2, i) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        throw new Error(`Failed after ${maxRetries} attempts. Last error: ${lastError.message}`);
    }

    /**
     * Generates an image using the Imagen API.
     */
    async function generateImage() {
        loadingIndicator.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        imageDisplay.innerHTML = loadingIndicator.outerHTML; // Reset display with loading spinner

        const payload = { 
            instances: { prompt: promptText }, 
            parameters: { "sampleCount": 1 } 
        };
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        try {
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const base64Data = result.predictions[0].bytesBase64Encoded;
                const imageUrl = `data:image/png;base64,${base64Data}`;

                // Clear loading indicator
                imageDisplay.innerHTML = ''; 
                
                // Display the image
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = "Generated Hero Image for VendorFindr App";
                imgElement.classList.add('w-full', 'h-full', 'object-contain', 'rounded-lg');
                imageDisplay.appendChild(imgElement);

            } else {
                errorMessage.textContent = "Image generation failed: No valid image data returned.";
                errorMessage.classList.remove('hidden');
                console.error("API response missing image data:", result);
            }

        } catch (error) {
            errorMessage.textContent = `Image generation failed. Please try again.`;
            errorMessage.classList.remove('hidden');
            console.error("Fetch error:", error);
        } finally {
            // Ensure the initial loading spinner is removed if the inner structure changed
            const finalLoading = document.getElementById('loading');
            if (finalLoading) finalLoading.remove();
        }
    }

    // Start image generation on load
    document.addEventListener('DOMContentLoaded', generateImage);
</script>

</body>
</html>
